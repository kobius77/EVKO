name: Scrape Events

on:
  schedule:
    - cron: '0 6 * * *' # Täglich um 06:00 UTC
  workflow_dispatch:
    inputs:
      task_selection:
        description: 'Welchen Scraper ausführen?'
        required: true
        default: 'all'
        type: choice
        options:
          - 'all'        # Alles scrapen + Website bauen
          - 'city'       # Stadt scrapen + Website bauen
          - 'handball'   # Nur Handball DB Update
          - 'kicks'      # Nur Fussball DB Update
          - 'build'      # Nur Website neu bauen (HTML)

permissions:
  contents: write

jobs:
  scrape_and_build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          pip install requests beautifulsoup4 fake-useragent openai

      # --- SCHRITT: Wochentag prüfen ---
      # Gibt den Wochentag als Zahl aus (1=Montag ... 5=Freitag ... 7=Sonntag)
      - name: Check Day of Week
        id: date_check
        run: echo "dow=$(date +%u)" >> $GITHUB_OUTPUT

      # --- 1. STADT SCRAPER (korneuburg.gv.at) ---
      # Läuft: Täglich (Schedule) ODER bei manueller Auswahl 'all'/'city'
      - name: Run City Scraper
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        if: >
          github.event_name == 'schedule' || 
          github.event.inputs.task_selection == 'all' || 
          github.event.inputs.task_selection == 'city'
        run: python scraper.py

      # --- 2. HANDBALL SCRAPER (nuLiga) ---
      # Läuft: Nur Freitags (Schedule & dow==5) ODER bei manueller Auswahl 'all'/'handball'
      - name: Run Handball Scraper
        if: >
          (github.event_name == 'schedule' && steps.date_check.outputs.dow == '5') || 
          github.event.inputs.task_selection == 'all' || 
          github.event.inputs.task_selection == 'handball'
        run: python scraper_nuliga.py

      # --- 3. FUSSBALL SCRAPER (Ligaportal) ---
      # Läuft: Nur Freitags (Schedule & dow==5) ODER bei manueller Auswahl 'all'/'kicks'
      - name: Run Kicks Scraper
        if: >
          (github.event_name == 'schedule' && steps.date_check.outputs.dow == '5') || 
          github.event.inputs.task_selection == 'all' || 
          github.event.inputs.task_selection == 'kicks'
        run: python scraper_kicks.py

      # --- 4. WEBSITE BUILDER ---
      # Läuft: Täglich (Schedule) ODER bei manueller Auswahl 'all'/'build'/'city'
      # (Läuft immer mit, damit evtl. gelöschte Events rausfliegen)
      - name: Build Website (HTML)
        if: >
          github.event_name == 'schedule' || 
          github.event.inputs.task_selection == 'all' || 
          github.event.inputs.task_selection == 'build' ||
          github.event.inputs.task_selection == 'city'
        run: python builder.py

      # --- COMMIT & PUSH ---
      - name: Commit and push changes
        run: |
          git config --global user.name 'GitHub Action'
          git config --global user.email 'action@github.com'
          git add evko.db index.html
          # Nur committen, wenn sich was geändert hat
          git diff --quiet && git diff --staged --quiet || (git commit -m "Update Data [Manual: ${{ github.event.inputs.task_selection || 'Auto' }}]" && git push)
