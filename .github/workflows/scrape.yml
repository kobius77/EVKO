name: Scrape Events

on:
  schedule:
    - cron: '0 6 * * *' # Täglich um 06:00 UTC
  workflow_dispatch:
    inputs:
      task_selection:
        description: 'Welchen Scraper ausführen?'
        required: true
        default: 'all'
        type: choice
        options:
          - 'all'        # Alles (Scrape + Embed + Build)
          - 'city'       # Stadt (Scrape + Embed + Build)
          - 'kinderwelt' # Kinderwelt (Scrape + Embed + Build)
          - 'handball'   # Handball (Scrape + Embed + Build)
          - 'kicks'      # Fussball (Scrape + Embed + Build)
          - 'embed'      # Nur Embeddings generieren (+ Build)
          - 'build'      # Nur Website/JSON neu bauen

permissions:
  contents: write

jobs:
  scrape_and_build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          pip install requests beautifulsoup4 fake-useragent openai

      # --- SCHRITT: Wochentag prüfen ---
      - name: Check Day of Week
        id: date_check
        run: echo "dow=$(date +%u)" >> $GITHUB_OUTPUT

      # --- 1. STADT SCRAPER ---
      - name: Run City Scraper
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        if: >
          github.event_name == 'schedule' || 
          github.event.inputs.task_selection == 'all' || 
          github.event.inputs.task_selection == 'city'
        run: python scraper_evko.py

      # --- 2. KINDERWELT SCRAPER ---
      - name: Run Kinderwelt Scraper
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        if: >
          github.event_name == 'schedule' || 
          github.event.inputs.task_selection == 'all' || 
          github.event.inputs.task_selection == 'kinderwelt'
        run: python scraper_kinderwelt.py

      # --- 3. HANDBALL SCRAPER ---
      - name: Run Handball Scraper
        if: >
          (github.event_name == 'schedule' && steps.date_check.outputs.dow == '5') || 
          github.event.inputs.task_selection == 'all' || 
          github.event.inputs.task_selection == 'handball'
        run: python scraper_handball.py

      # --- 4. FUSSBALL SCRAPER ---
      - name: Run Kicks Scraper
        if: >
          (github.event_name == 'schedule' && steps.date_check.outputs.dow == '5') || 
          github.event.inputs.task_selection == 'all' || 
          github.event.inputs.task_selection == 'kicks'
        run: python scraper_kicks.py

      # --- 5. EMBEDDINGS (KI Vektoren) ---
      # Läuft bei 'embed' explizit mit
      - name: Generate Embeddings
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        if: >
          always() && (
            github.event_name == 'schedule' || 
            github.event.inputs.task_selection == 'all' || 
            github.event.inputs.task_selection == 'city' ||
            github.event.inputs.task_selection == 'kinderwelt' ||
            github.event.inputs.task_selection == 'handball' ||
            github.event.inputs.task_selection == 'kicks' ||
            github.event.inputs.task_selection == 'embed'
          )
        run: python embedder.py

      # --- 6. WEBSITE BUILDER ---
      # Läuft auch bei 'embed', damit die JSON aktualisiert wird
      - name: Build Website (HTML & JSON)
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        if: >
          always() && (
            github.event_name == 'schedule' || 
            github.event.inputs.task_selection == 'all' || 
            github.event.inputs.task_selection == 'build' ||
            github.event.inputs.task_selection == 'city' ||
            github.event.inputs.task_selection == 'kinderwelt' ||
            github.event.inputs.task_selection == 'handball' ||
            github.event.inputs.task_selection == 'kicks' ||
            github.event.inputs.task_selection == 'embed'
          )
        run: python builder.py
      
      # --- COMMIT & PUSH ---
      - name: Commit and push changes
        run: |
          git config --global user.name 'GitHub Action'
          git config --global user.email 'action@github.com'
          git add evko.db index.html events.json kinderwelt.state
          # Nur committen, wenn sich tatsächlich Daten geändert haben
          git diff --quiet && git diff --staged --quiet || (git commit -m "Update Data [Manual: ${{ github.event.inputs.task_selection || 'Auto' }}]" && git push)
